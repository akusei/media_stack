---
- name: "Restart {{ container_name }}"
  ansible.builtin.command:
    chdir: "{{ _containers_compose_root[container_name] }}"
    cmd: "{{ item.command }}"
  changed_when: true
  when: >-
    container_name in _containers_compose_root and
    not (manifest.stack.skip_handler | default(False) | bool)
  loop_control:
    label: "{{ item.name }}"
  loop:
    - name: Build if needed
      command: docker compose build --no-cache
    - name: Pulling image
      command: docker compose pull --ignore-buildable
    - name: Restarting container
      command: docker compose up -d --force-recreate
